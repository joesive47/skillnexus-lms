# AWS ECS Task Definition for SkillNexus
apiVersion: v1
kind: ConfigMap
metadata:
  name: skillnexus-ecs-task
data:
  task-definition.json: |
    {
      "family": "skillnexus-web",
      "networkMode": "awsvpc",
      "requiresCompatibilities": ["FARGATE"],
      "cpu": "1024",
      "memory": "2048",
      "executionRoleArn": "arn:aws:iam::ACCOUNT:role/ecsTaskExecutionRole",
      "taskRoleArn": "arn:aws:iam::ACCOUNT:role/ecsTaskRole",
      "containerDefinitions": [
        {
          "name": "skillnexus-web",
          "image": "ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/skillnexus:latest",
          "portMappings": [
            {
              "containerPort": 3000,
              "protocol": "tcp"
            }
          ],
          "environment": [
            {
              "name": "NODE_ENV",
              "value": "production"
            },
            {
              "name": "DATABASE_URL",
              "value": "postgresql://skillnexus:PASSWORD@skillnexus-postgres.region.rds.amazonaws.com:5432/skillnexus_lms"
            }
          ],
          "secrets": [
            {
              "name": "NEXTAUTH_SECRET",
              "valueFrom": "arn:aws:secretsmanager:us-east-1:ACCOUNT:secret:skillnexus/auth-secret"
            },
            {
              "name": "STRIPE_SECRET_KEY",
              "valueFrom": "arn:aws:secretsmanager:us-east-1:ACCOUNT:secret:skillnexus/stripe-key"
            }
          ],
          "logConfiguration": {
            "logDriver": "awslogs",
            "options": {
              "awslogs-group": "/ecs/skillnexus",
              "awslogs-region": "us-east-1",
              "awslogs-stream-prefix": "ecs"
            }
          },
          "healthCheck": {
            "command": ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"],
            "interval": 30,
            "timeout": 5,
            "retries": 3,
            "startPeriod": 60
          }
        }
      ]
    }

---
# ECS Service Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: skillnexus-ecs-service
data:
  service.json: |
    {
      "serviceName": "skillnexus-web-service",
      "cluster": "skillnexus-cluster",
      "taskDefinition": "skillnexus-web",
      "desiredCount": 3,
      "launchType": "FARGATE",
      "networkConfiguration": {
        "awsvpcConfiguration": {
          "subnets": ["subnet-xxx", "subnet-yyy"],
          "securityGroups": ["sg-xxx"],
          "assignPublicIp": "DISABLED"
        }
      },
      "loadBalancers": [
        {
          "targetGroupArn": "arn:aws:elasticloadbalancing:us-east-1:ACCOUNT:targetgroup/skillnexus-tg",
          "containerName": "skillnexus-web",
          "containerPort": 3000
        }
      ],
      "serviceTags": [
        {
          "key": "Environment",
          "value": "production"
        },
        {
          "key": "Application",
          "value": "SkillNexus"
        }
      ]
    }